---
// Main calendar page
import CalendarGrid from '../components/CalendarGrid';
import Snowfall from '../components/Snowfall';
import ThemeToggle from '../components/ThemeToggle';
import { calendarConfig } from '../config/calendar-content';
import "../styles/global.css";

const { title, subtitle, contents } = calendarConfig;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>{title} - Advent Calendar</title>
    <meta name="description" content={subtitle} />

    <!-- Theme initialization script - runs before page load to prevent flash -->
    <script is:inline>
      (function() {
        const storedTheme = localStorage.getItem('theme');
        const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        const theme = storedTheme || systemTheme;

        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      })();
    </script>

    <!-- Auth check script -->
    <script>
      import { isDemoMode } from '../lib/featureFlags';
      import { getCurrentUser, getCurrentFriend } from '../lib/auth';

      async function checkAuth() {
        // In demo mode, skip authentication
        if (isDemoMode()) {
          return;
        }

        // Check if user is authenticated
        const user = await getCurrentUser();
        if (!user) {
          // Redirect to login if not authenticated
          window.location.href = '/login';
          return;
        }

        // Get friend info and display user menu
        const friend = await getCurrentFriend();
        if (friend) {
          displayUserMenu(friend.name, friend.email);
        } else {
          displayUserMenu(user.email || 'User', user.email || '');
        }
      }

      function displayUserMenu(name: string, email: string) {
        const userMenuElement = document.getElementById('user-menu');
        if (!userMenuElement) return;

        // Create elements using DOM API to prevent XSS
        const container = document.createElement('div');
        container.className = 'relative group';

        const button = document.createElement('button');
        button.className = 'flex items-center gap-2 px-3 py-2 rounded-lg bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm shadow-lg hover:shadow-xl transition-all';

        const avatar = document.createElement('div');
        avatar.className = 'w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-white font-semibold';
        avatar.textContent = name.charAt(0).toUpperCase();

        const userInfo = document.createElement('div');
        userInfo.className = 'text-left hidden md:block';

        const nameDiv = document.createElement('div');
        nameDiv.className = 'text-sm font-medium text-gray-900 dark:text-white';
        nameDiv.textContent = name;

        const emailDiv = document.createElement('div');
        emailDiv.className = 'text-xs text-gray-500 dark:text-gray-400';
        emailDiv.textContent = email;

        userInfo.appendChild(nameDiv);
        userInfo.appendChild(emailDiv);

        button.appendChild(avatar);
        button.appendChild(userInfo);

        const dropdown = document.createElement('div');
        dropdown.className = 'absolute right-0 mt-2 w-48 rounded-lg bg-white dark:bg-gray-800 shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all';

        const logoutBtn = document.createElement('button');
        logoutBtn.id = 'logout-btn';
        logoutBtn.className = 'w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg';
        logoutBtn.textContent = 'Sign out';
        logoutBtn.addEventListener('click', handleLogout);

        dropdown.appendChild(logoutBtn);

        container.appendChild(button);
        container.appendChild(dropdown);

        // Clear and append
        userMenuElement.textContent = '';
        userMenuElement.appendChild(container);
      }

      async function handleLogout() {
        const { signOut } = await import('../lib/auth');
        const result = await signOut();
        if (result.success) {
          window.location.href = '/login';
        } else {
          alert('Failed to sign out: ' + result.error);
        }
      }

      // Run auth check on page load
      checkAuth();
    </script>
  </head>
  <body class="min-h-screen bg-background text-foreground">
    <!-- Snowfall effect -->
    <Snowfall client:load enabled={true} />

    <!-- Theme toggle and user menu -->
    <div class="fixed top-4 right-4 z-50 flex items-center gap-2">
      <div id="user-menu"></div>
      <ThemeToggle client:load />
    </div>

    <!-- Main content -->
    <div class="relative z-10">
      <!-- Header -->
      <header class="py-12 md:py-16 text-center px-4">
        <h1 class="text-4xl md:text-6xl font-serif font-bold text-foreground mb-4 text-balance">
          {title}
        </h1>
        <p class="text-lg md:text-xl text-muted-foreground max-w-2xl mx-auto leading-relaxed">
          {subtitle}
        </p>
        
        <!-- Decorative element -->
        <div class="flex justify-center mt-6">
          <div class="w-24 h-1 bg-gradient-to-r from-transparent via-accent to-transparent rounded-full"></div>
        </div>
      </header>

      <!-- Calendar -->
      <main class="container mx-auto px-4 pb-16 max-w-6xl">
        <CalendarGrid client:load contents={contents} />
      </main>

      <!-- Footer -->
      <footer class="py-8 text-center text-sm text-muted-foreground">
        <p>Made with ❤️ for the holidays</p>
      </footer>
    </div>
  </body>
</html>
